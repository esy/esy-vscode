{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "JSON schema for ESY or NPM package.json files",
  "allOf": [{
    "$ref": "http://json.schemastore.org/package#"
  }],
  "definitions": {
    "detectEsy": {
      "required": ["esy"]
    },
    "detectOverride": {
      "anyOf": [{
        "required": ["override"]
      }, {
        "required": ["source"]
      }]
    },
    "cmdsDef": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "minItems": 1
    },
    "sandboxConfig": {
      "type": "object",
      "properties": {
        "build": {
          "description": "List of commands that describe how your package's default targets should be built when package is being used as a dependency",
          "default": ["dune build -p #{self.name}"],
          "allOf": [{
            "$ref": "#/definitions/cmdsDef"
          }]
        },
        "buildDev": {
          "description": "List of commands that describe how your package's default targets should be built when package is being developed",
          "default": ["dune build -p #{self.name}"],
          "allOf": [{
            "$ref": "#/definitions/cmdsDef"
          }]
        },
        "install": {
          "description": "Allows to specify a list of commands which should move built artifacts to #{self.install} location.",
          "allOf": [{
            "$ref": "#/definitions/cmdsDef"
          }]
        },
        "buildsInSource": {
          "description": "Allows to modify the building mode. Dune / OcamlBuild users should use \"_build\"",
          "enum": ["_build", true, false],
          "default": false
        },
        "exportedEnv": {
          "description": "Exports new environment variables to the esy build environment, used when package is built as a dependency",
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "val": {
                "type": "string",
                "description": "New value of the environment variable. It can use esy's variable substitution syntax"
              },
              "scope": {
                "enum": ["global", "local"],
                "description": "Defines the scope of the environment variable (either global or local)"
              }
            },
            "required": ["val", "scope"]
          },
          "minProperties": 1
        },
        "buildEnv": {
          "description": "Exports new environment variables to the build environment of the current package",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "minProperties": 1
        }
      }
    },
    "esyDef": {
      "required": ["esy"],
      "properties": {
        "esy": {
          "allOf": [{
            "$ref": "#/definitions/sandboxConfig"
          }],
          "description": "Additional information needed by esy to build, install or release the project",
          "required": [
            "build"
          ],
          "properties": {
            "release": {
              "type": "object",
              "required": ["bin"],
              "properties": {
                "bin": {
                  "description": "List of all executable names which must be made available on $PATH when release is installed on user machine",
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "includePackages": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "description": "Project dependencies that must be bundled as part of the project's release",
                  "minItems": 1
                },
                "rewritePrefix": {
                  "type": "boolean",
                  "default": false,
                  "description": "Activate path rewriting in artifcats during release installation"
                }
              }
            }
          }
        }
      }
    },
    "overrideDef": {
      "required": ["source", "override"],
      "$comment": "If we give a source, then we have to give an override and vice-versa",
      "properties": {
        "source": {
          "type": "string",
          "description": "Defines the origin configuration which is being overriden. To use only with \"override\"",
          "default": "./package.json"
        },
        "override": {
          "allOf": [{
            "$ref": "#/definitions/sandboxConfig"
          }],
          "description": "Used to specify sandbox configuration overrides, based on the configuration given with the \"source\" keyword",
          "properties": {
            "buildEnvOverride": {
              "description": "Overrides buildEnv by adding or deleting environment variables",
              "type": "object",
              "additionalProperties": {
                "type": ["string", "null"]
              },
              "minProperties": 1
            },
            "exportedEnvOverride": {
              "description": "Overrides exportedEnv by adding or deleting environment variables. Set an environment variable to null to remove it from preexisting exported environment",
              "type": "object",
              "minProperties": 1,
              "additionalProperties": {
                "oneOf": [{
                    "type": "null"
                  },
                  {
                    "type": "object",
                    "properties": {
                      "val": {
                        "type": "string",
                        "description": "New value of the environment variable. It can use esy's variable substitution syntax"
                      },
                      "scope": {
                        "enum": ["global", "local"],
                        "description": "Defines the scope of the environment variable (either global or local)"
                      }
                    },
                    "required": ["val", "scope"]
                  }
                ]
              }
            }
          }
        }
      }
    }
  },
  "$comment": "If an esy property or source/override is detected, then only one of them can apply. (i.e. cannot have both esy and source/override.",
  "if": {
    "anyOf": [{
        "$ref": "#/definitions/detectEsy"
      },
      {
        "$ref": "#/definitions/detectOverride"
      }
    ]
  },
  "then": {
    "oneOf": [{
        "$ref": "#/definitions/esyDef"
      },
      {
        "$ref": "#/definitions/overrideDef"
      }
    ]
  }
}